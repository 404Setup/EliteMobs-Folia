package com.magmaguy.elitemobs.collateralminecraftchanges;

import com.magmaguy.elitemobs.MetadataHandler;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Entity;
import org.bukkit.entity.LivingEntity;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.util.Vector;

public class PreventDarkroomExploit implements Listener {

    @EventHandler
    public void onDamage(EntityDamageEvent event) {

        if (!event.getEntity().hasMetadata(MetadataHandler.NATURAL_MOB_MD)) return;

        int livingEntityCount = 0;
        for (Entity entity : event.getEntity().getNearbyEntities(1, 1, 1)) {

            if (entity instanceof LivingEntity)
                livingEntityCount++;

        }

        if (livingEntityCount < 2) return;

        Location entityLocation = event.getEntity().getLocation().getBlock().getLocation().add(0.5, 0, 0.5);

        Block block1 = entityLocation.clone().add(new Vector(0, 0, 1)).getBlock();
        Block block2 = entityLocation.clone().add(new Vector(0, 0, -1)).getBlock();
        Block block3 = entityLocation.clone().add(new Vector(0, 1, 1)).getBlock();
        Block block4 = entityLocation.clone().add(new Vector(0, 1, -1)).getBlock();
        Block block5 = entityLocation.clone().add(new Vector(1, 0, 0)).getBlock();
        Block block6 = entityLocation.clone().add(new Vector(-1, 0, 0)).getBlock();
        Block block7 = entityLocation.clone().add(new Vector(1, 1, 0)).getBlock();
        Block block8 = entityLocation.clone().add(new Vector(-1, 1, 0)).getBlock();

        if (!block3.getType().equals(Material.AIR) && !block4.getType().equals(Material.AIR) &&
                !block7.getType().equals(Material.AIR) && !block8.getType().equals(Material.AIR)) {
            event.getEntity().removeMetadata(MetadataHandler.NATURAL_MOB_MD, MetadataHandler.PLUGIN);
            return;
        }

        int airCount = 0;

        if (block1.getType().equals(Material.AIR))
            airCount++;
        if (block2.getType().equals(Material.AIR))
            airCount++;
        if (block3.getType().equals(Material.AIR))
            airCount++;
        if (block4.getType().equals(Material.AIR))
            airCount++;
        if (block5.getType().equals(Material.AIR))
            airCount++;
        if (block6.getType().equals(Material.AIR))
            airCount++;
        if (block7.getType().equals(Material.AIR))
            airCount++;
        if (block8.getType().equals(Material.AIR))
            airCount++;

        if (airCount >= 4) return;

        event.getEntity().removeMetadata(MetadataHandler.NATURAL_MOB_MD, MetadataHandler.PLUGIN);

    }

}
