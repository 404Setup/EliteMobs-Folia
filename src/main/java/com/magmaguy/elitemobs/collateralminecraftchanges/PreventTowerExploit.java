package com.magmaguy.elitemobs.collateralminecraftchanges;

import com.magmaguy.elitemobs.EntityTracker;
import com.magmaguy.elitemobs.mobconstructor.EliteMobEntity;
import com.magmaguy.elitemobs.utils.EntityFinder;
import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Player;
import org.bukkit.entity.Projectile;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.util.Vector;

public class PreventTowerExploit implements Listener {

    @EventHandler
    public void onHit(EntityDamageByEntityEvent event) {

        if (!(event instanceof LivingEntity)) return;
        if (!EntityFinder.getRealDamager(event).getType().equals(EntityType.PLAYER)) return;
        EliteMobEntity eliteMobEntity = EntityTracker.getEliteMobEntity(event.getEntity());
        if (eliteMobEntity == null) return;

        Location mobLocation = event.getEntity().getLocation().add(new Vector(0.5, 0, 0.5));
        Location playerLocation;
        if (event.getDamager() instanceof Player)
            playerLocation = event.getDamager().getLocation();
        else
            playerLocation = ((Player) ((Projectile) event.getDamager()).getShooter()).getLocation().getBlock().getLocation().add(new Vector(0.5, 0, 0.5));

        if (playerLocation.getY() - mobLocation.getY() < 2) return;

        Block block1 = playerLocation.clone().add(new Vector(0, -1, 1)).getBlock();
        Block block2 = playerLocation.clone().add(new Vector(0, -1, -1)).getBlock();
        Block block3 = playerLocation.clone().add(new Vector(0, -2, 1)).getBlock();
        Block block4 = playerLocation.clone().add(new Vector(0, -2, -1)).getBlock();
        Block block5 = playerLocation.clone().add(new Vector(1, -1, 0)).getBlock();
        Block block6 = playerLocation.clone().add(new Vector(-1, -1, 0)).getBlock();
        Block block7 = playerLocation.clone().add(new Vector(1, -2, 0)).getBlock();
        Block block8 = playerLocation.clone().add(new Vector(-1, -2, 0)).getBlock();

        if (!(block1.getType().equals(Material.AIR) && block2.getType().equals(Material.AIR) &&
                block3.getType().equals(Material.AIR) && block4.getType().equals(Material.AIR) &&
                block5.getType().equals(Material.AIR) && block6.getType().equals(Material.AIR) &&
                block7.getType().equals(Material.AIR) && block8.getType().equals(Material.AIR)))
            return;

        eliteMobEntity.setHasSpecialLoot(false);
        Bukkit.getLogger().warning("tower exploit");
        AntiExploitMessage.sendWarning((LivingEntity) event.getEntity());

    }

}
